@extends('layouts.app')

@section('title', 'Pentest Results')

@section('content')
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="fas fa-shield-alt me-2"></i>Pentest Session Results</h1>
                <p class="text-muted mb-0">
                    Session #{{ $session->id }} - 
                    <span class="badge bg-{{ $session->status === 'completed' ? 'success' : ($session->status === 'failed' ? 'danger' : 'warning') }}">
                        {{ ucfirst($session->status) }}
                    </span>
                </p>
            </div>
            <div>
                <a href="{{ route('pentest.sessions') }}" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-list me-1"></i>All Sessions
                </a>
                @if($session->status === 'completed')
                    <button class="btn btn-success" onclick="exportResults()">
                        <i class="fas fa-download me-1"></i>Export Report
                    </button>
                @endif
            </div>
        </div>
    </div>
</div>

<!-- Session Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-primary">{{ $session->selected_ips ? count($session->selected_ips) : 0 }}</h3>
                <p class="mb-0">Target IPs</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-warning">{{ $session->results->count() }}</h3>
                <p class="mb-0">Findings</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-danger">{{ $session->results->where('severity', 'critical')->count() + $session->results->where('severity', 'high')->count() }}</h3>
                <p class="mb-0">Critical/High</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-info">{{ $session->credentials->count() }}</h3>
                <p class="mb-0">Credentials Found</p>
            </div>
        </div>
    </div>
</div>

<!-- Progress Bar (if running) -->
@if($session->status === 'running')
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-body">
                <h6><i class="fas fa-cog fa-spin me-2"></i>Pentest in Progress</h6>
                <div class="progress">
                    @php 
                    $progress = "style=\"width: {{ $session->progress }}%\""
                    @endphp
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="progress-bar" role="progressbar" {{ $progress }}>
                        {{ $session->progress }}%
                    </div>
                </div>
                <small class="text-muted">Started: {{ $session->created_at->format('Y-m-d H:i:s') }}</small>

            </div>
        </div>
    </div>
</div>
@elseif($session->status === 'failed')
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Pentest failed. Please check logs or try again.<br>
            @if($session->description)
                <small class="text-muted">{{ $session->description }}</small>
            @endif
        </div>
    </div>
</div>
@endif

<!-- Results by IP -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bug me-2"></i>Vulnerability Findings</h5>
            </div>
            <div class="card-body">
                @if($session->results->count() > 0)
                    <div class="accordion" id="resultsAccordion">
                        @foreach($session->selected_ips as $ip)
                            @php
                                $ipResults = $session->results->where('target_ip', $ip);
                                $severityCounts = [
                                    'critical' => $ipResults->where('severity', 'critical')->count(),
                                    'high' => $ipResults->where('severity', 'high')->count(),
                                    'medium' => $ipResults->where('severity', 'medium')->count(),
                                    'low' => $ipResults->where('severity', 'low')->count(),
                                    'info' => $ipResults->where('severity', 'info')->count()
                                ];
                            @endphp
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading{{ $loop->index }}">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#collapse{{ $loop->index }}">
                                        <strong>{{ $ip }}</strong>
                                        <span class="ms-3">
                                            @if($severityCounts['critical'] > 0)
                                                <span class="badge bg-danger">{{ $severityCounts['critical'] }} Critical</span>
                                            @endif
                                            @if($severityCounts['high'] > 0)
                                                <span class="badge bg-warning">{{ $severityCounts['high'] }} High</span>
                                            @endif
                                            @if($severityCounts['medium'] > 0)
                                                <span class="badge bg-info">{{ $severityCounts['medium'] }} Medium</span>
                                            @endif
                                            @if($severityCounts['low'] > 0)
                                                <span class="badge bg-secondary">{{ $severityCounts['low'] }} Low</span>
                                            @endif
                                            @if($ipResults->count() === 0)
                                                <span class="badge bg-success">No Issues</span>
                                            @endif
                                        </span>
                                    </button>
                                </h2>
                                <div id="collapse{{ $loop->index }}" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        @if($ipResults->count() > 0)
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Module</th>
                                                            <th>Finding</th>
                                                            <th>Severity</th>
                                                            <th>Details</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach($ipResults as $result)
                                                            <tr>
                                                                <td>
                                                                    <span class="badge bg-primary">{{ $result->module_type }}</span>
                                                                </td>
                                                                <td>{{ $result->test_name }}</td>
                                                                <td>
                                                                    <span class="badge bg-{{ 
                                                                        $result->severity === 'critical' ? 'danger' : 
                                                                        ($result->severity === 'high' ? 'warning' : 
                                                                        ($result->severity === 'medium' ? 'info' : 'secondary')) 
                                                                    }}">
                                                                        {{ ucfirst($result->severity) }}
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    @if($result->details)
                                                                        <button class="btn btn-sm btn-outline-info" 
                                                                                data-bs-toggle="modal" 
                                                                                data-bs-target="#detailModal{{ $result->id }}">
                                                                            View Details
                                                                        </button>
                                                                    @endif
                                                                </td>
                                                            </tr>
                                                        @endforeach
                                                    </tbody>
                                                </table>
                                            </div>
                                        @else
                                            <p class="text-muted mb-0">No vulnerabilities found for this IP.</p>
                                        @endif
                                    </div>
                                </div>
                            </div>
                        @endforeach
                    </div>
                @else
                    <div class="text-center py-5">
                        @if($session->status === 'running')
                            <i class="fas fa-cog fa-spin fa-2x text-muted mb-3"></i>
                            <p class="text-muted">Scanning in progress... Results will appear here.</p>
                        @else
                            <i class="fas fa-shield-alt fa-2x text-success mb-3"></i>
                            <p class="text-muted">No vulnerabilities detected! Your targets appear secure.</p>
                        @endif
                    </div>
                @endif
            </div>
        </div>
    </div>
</div>

<!-- Discovered Credentials -->
@if($session->credentials->count() > 0)
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-key me-2"></i>Discovered Credentials</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>IP Address</th>
                                <th>Service</th>
                                <th>Username</th>
                                <th>Password</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach($session->credentials as $cred)
                                <tr>
                                    <td>{{ $cred->ip_address }}</td>
                                    <td><span class="badge bg-primary">{{ $cred->service }}</span></td>
                                    <td><code>{{ $cred->username }}</code></td>
                                    <td><code>{{ $cred->password }}</code></td>
                                    <td>
                                        <span class="badge bg-{{ $cred->verified ? 'success' : 'warning' }}">
                                            {{ $cred->verified ? 'Verified' : 'Unverified' }}
                                        </span>
                                    </td>
                                </tr>
                            @endforeach
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
@endif

<!-- Detail Modals -->
@foreach($session->results as $result)
    @if($result->details)
        <div class="modal fade" id="detailModal{{ $result->id }}" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">{{ $result->test_name }} - {{ $result->ip_address }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <pre><code>{{ is_array($result->details) ? json_encode($result->details, JSON_PRETTY_PRINT) : $result->details }}</code></pre>
                    </div>
                </div>
            </div>
        </div>
    @endif
@endforeach
@endsection

@push('scripts')
<script>
    // Auto-refresh if session is running
    @if($session->status === 'running')
        setInterval(function() {
            location.reload();
        }, 10000); // Refresh every 10 seconds
    @elseif($session->status === 'failed')
        $(document).ready(function() {
            $('.progress-bar').removeClass('progress-bar-animated');
            $('.progress').after('<div class="alert alert-danger mt-3">Pentest failed. Please check logs or try again.</div>');
        });
    @endif

    function exportResults() {
        window.location.href = '/pentest/session/{{ $session->id }}/export';
    }
</script>
@endpush
