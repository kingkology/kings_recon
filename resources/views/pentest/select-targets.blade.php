@extends('layouts.app')

@section('title', 'Select Pentest Targets')

@section('content')
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="fas fa-crosshairs me-2"></i>Select Pentest Targets</h1>
                <p class="text-muted mb-0">{{ $batch->filename }} - Choose IPs and modules for deep testing</p>
            </div>
            <div>
                <a href="{{ route('scan.show', $batch->batch_id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to Results
                </a>
            </div>
        </div>
    </div>
</div>

<form id="pentest-form">
    @csrf
    <div class="row">
        <!-- IP Selection -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-network-wired me-2"></i>Select Target IPs
                        <button type="button" class="btn btn-sm btn-outline-primary float-end" onclick="toggleAllIps()">
                            Toggle All
                        </button>
                    </h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    @if($onlineIps->count() > 0)
                        @foreach($onlineIps as $ip)
                            <div class="form-check mb-2">
                                <input class="form-check-input ip-checkbox" type="checkbox" 
                                       name="selected_ips[]" value="{{ $ip->ip_address }}" 
                                       id="ip_{{ $ip->id }}">
                                <label class="form-check-label" for="ip_{{ $ip->id }}">
                                    <strong>{{ $ip->ip_address }}</strong>
                                    <small class="text-muted">({{ $ip->ping_time }}ms)</small>
                                    @if(!empty($ip->open_ports))
                                        <br>
                                        <small>
                                            Ports: 
                                            @foreach($ip->open_ports as $port => $service)
                                                <span class="badge bg-secondary">{{ $port }}</span>
                                            @endforeach
                                        </small>
                                    @endif
                                    @if(!empty($ip->vulnerable_ports))
                                        <br>
                                        <small class="text-danger">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            {{ count($ip->vulnerable_ports) }} vulnerabilities found
                                        </small>
                                    @endif
                                </label>
                            </div>
                        @endforeach
                    @else
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle fa-2x mb-2"></i>
                            <p>No online hosts found to test</p>
                        </div>
                    @endif
                </div>
            </div>
        </div>

        <!-- Module Selection -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Select Pentest Modules</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="selected_modules[]" 
                               value="web_vuln" id="mod_web_vuln">
                        <label class="form-check-label" for="mod_web_vuln">
                            <strong>Web Vulnerability Scanner</strong>
                            <br>
                            <small class="text-muted">
                                Directory traversal, XSS, SQL injection, file inclusion attacks
                            </small>
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="selected_modules[]" 
                               value="brute_force" id="mod_brute_force">
                        <label class="form-check-label" for="mod_brute_force">
                            <strong>Brute Force Attack</strong>
                            <br>
                            <small class="text-muted">
                                SSH, FTP, RDP, SMB credential attacks using common passwords
                            </small>
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="selected_modules[]" 
                               value="service_enum" id="mod_service_enum">
                        <label class="form-check-label" for="mod_service_enum">
                            <strong>Service Enumeration</strong>
                            <br>
                            <small class="text-muted">
                                Banner grabbing, version detection, configuration analysis
                            </small>
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="selected_modules[]" 
                               value="exploit_test" id="mod_exploit_test">
                        <label class="form-check-label" for="mod_exploit_test">
                            <strong>Exploit Testing</strong>
                            <br>
                            <small class="text-muted">
                                Known CVE exploitation, default credential testing
                            </small>
                        </label>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Session Description (Optional)</label>
                        <textarea class="form-control" id="description" name="description" rows="3" 
                                  placeholder="Describe the purpose of this pentest session..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Legal Warning</h6>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <strong>IMPORTANT:</strong> Only use this tool on systems you own or have explicit permission to test.
                        Unauthorized penetration testing is illegal and may result in criminal charges.
                    </p>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="legal_consent" required>
                        <label class="form-check-label" for="legal_consent">
                            I confirm that I have authorization to perform penetration testing on the selected targets.
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12 text-center">
            <button type="submit" class="btn btn-danger btn-lg" id="start-pentest-btn">
                <i class="fas fa-rocket me-2"></i>Start Penetration Testing
            </button>
        </div>
    </div>
</form>

<!-- Progress Modal -->
<div class="modal fade" id="pentestProgressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-cog fa-spin me-2"></i>Starting Pentest Session</h5>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-danger mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Setting up penetration testing environment...</p>
            </div>
        </div>
    </div>
</div>
@endsection

@push('scripts')
<script>
    function toggleAllIps() {
        const checkboxes = document.querySelectorAll('.ip-checkbox');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => cb.checked = !allChecked);
    }

    $('#pentest-form').on('submit', function(e) {
        e.preventDefault();

        const selectedIps = $('input[name="selected_ips[]"]:checked').length;
        const selectedModules = $('input[name="selected_modules[]"]:checked').length;

        if (selectedIps === 0) {
            alert('Please select at least one IP address to test.');
            return;
        }

        if (selectedModules === 0) {
            alert('Please select at least one pentest module.');
            return;
        }

        if (!$('#legal_consent').is(':checked')) {
            alert('You must confirm legal authorization before proceeding.');
            return;
        }

        const formData = $(this).serialize();
        
        $('#pentestProgressModal').modal('show');
        $('#start-pentest-btn').prop('disabled', true);

        $.ajax({
            url: '{{ route("pentest.create", $batch->batch_id) }}',
            type: 'POST',
            data: formData,
            success: function(response) {
                if (response.success) {
                    window.location.href = `/pentest/session/${response.session_id}/results`;
                } else {
                    alert('Error: ' + response.message);
                    $('#pentestProgressModal').modal('hide');
                    $('#start-pentest-btn').prop('disabled', false);
                }
            },
            error: function(xhr) {
                let errorMessage = 'An error occurred while starting the pentest session.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }
                alert('Error: ' + errorMessage);
                $('#pentestProgressModal').modal('hide');
                $('#start-pentest-btn').prop('disabled', false);
            }
        });
    });
</script>
@endpush
